!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).uhst={})}(this,(function(e){"use strict";var t,n=(t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])})(e,n)},function(e,n){function r(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}),r=function(e){function t(t){var n=this.constructor,r=e.call(this,t)||this;return Object.setPrototypeOf(r,n.prototype),r.name="InvalidToken",r}return n(t,e),t}(Error),i=function(e){function t(t){var n=this.constructor,r=e.call(this,t)||this;return Object.setPrototypeOf(r,n.prototype),r.name="InvalidHostId",r}return n(t,e),t}(Error),o=function(e){function t(t){var n=this.constructor,r=e.call(this,t)||this;return Object.setPrototypeOf(r,n.prototype),r.name="HostIdAlreadyInUse",r}return n(t,e),t}(Error),s=function(e){function t(t){var n=this.constructor,r=e.call(this,t)||this;return Object.setPrototypeOf(r,n.prototype),r.name="InvalidClientOrHostId",r}return n(t,e),t}(Error),a=function(e){function t(t){var n=this.constructor,r=e.call(this,t)||this;return Object.setPrototypeOf(r,n.prototype),r.name="RelayUnreachable",r}return n(t,e),t}(Error),c=function(e){function t(t){var n=this.constructor,r=e.call(this,t)||this;return Object.setPrototypeOf(r,n.prototype),r.name="RelayError",r}return n(t,e),t}(Error),u=function(e){function t(t){var n=this.constructor,r=e.call(this,t)||this;return Object.setPrototypeOf(r,n.prototype),r.name="NetworkUnreachable",r}return n(t,e),t}(Error),l=function(e){function t(t,n){var r=this.constructor,i=e.call(this,n)||this;return i.responseCode=t,Object.setPrototypeOf(i,r.prototype),i.name="NetworkError",i}return n(t,e),t}(Error),h=function(){return(h=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e}).apply(this,arguments)},f=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},d=function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},p={method:"POST"},y=function(e){return e?h(h({},p),{headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}):p},g=function(){function e(){}return e.prototype.post=function(e,t,n,r){return f(this,void 0,void 0,(function(){var i,o,s;return d(this,(function(a){switch(a.label){case 0:t&&t.length>0&&(e=e+"?"+t.join("&")),a.label=1;case 1:return a.trys.push([1,6,,7]),r?[4,this.fetchWithTimeout(e,h(h({},y(n)),{timeout:r}))]:[3,3];case 2:return o=a.sent(),[3,5];case 3:return[4,fetch(e,y(n))];case 4:o=a.sent(),a.label=5;case 5:return i=o,[3,7];case 6:throw s=a.sent(),new u(s);case 7:if(200==i.status)return[2,i.json()];throw new l(i.status,""+i.statusText)}}))}))},e.prototype.get=function(e,t,n){return f(this,void 0,void 0,(function(){var r,i,o;return d(this,(function(s){switch(s.label){case 0:t&&t.length>0&&(e=e+"?"+t.join("&")),s.label=1;case 1:return s.trys.push([1,6,,7]),n?[4,this.fetchWithTimeout(e,{timeout:n})]:[3,3];case 2:return i=s.sent(),[3,5];case 3:return[4,fetch(e)];case 4:i=s.sent(),s.label=5;case 5:return r=i,[3,7];case 6:throw o=s.sent(),new u(o);case 7:if(200==r.status)return[2,r.json()];throw new l(r.status,""+r.statusText)}}))}))},e.prototype.fetchWithTimeout=function(e,t){return f(this,void 0,void 0,(function(){var n,r,i,o,s;return d(this,(function(a){switch(a.label){case 0:return n=t.timeout,r=void 0===n?8e3:n,i=new AbortController,o=setTimeout((function(){return i.abort()}),r),[4,fetch(e,h(h({},t),{signal:i.signal}))];case 1:return s=a.sent(),clearTimeout(o),[2,s]}}))}))},e}(),b=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},v=function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},w=function(){function e(e,t){this.relayUrl=e,this.networkClient=null!=t?t:new g}return e.prototype.initHost=function(e){return b(this,void 0,void 0,(function(){var t;return v(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.networkClient.post(this.relayUrl,e?["action=host","hostId="+e]:["action=host"])];case 1:return[2,n.sent()];case 2:throw(t=n.sent())instanceof l?400==t.responseCode?new o(t.message):new c(t.message):new a(t);case 3:return[2]}}))}))},e.prototype.initClient=function(e){return b(this,void 0,void 0,(function(){var t;return v(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,this.networkClient.post(this.relayUrl,["action=join","hostId="+e])];case 1:return[2,n.sent()];case 2:throw(t=n.sent())instanceof l?400==t.responseCode?new i(t.message):new c(t.message):new a(t);case 3:return[2]}}))}))},e.prototype.sendMessage=function(e,t,n){return b(this,void 0,void 0,(function(){var i,o;return v(this,(function(u){switch(u.label){case 0:i=null!=n?n:this.relayUrl,u.label=1;case 1:return u.trys.push([1,3,,4]),[4,this.networkClient.post(i,["token="+e],t)];case 2:return[2,u.sent()];case 3:throw(o=u.sent())instanceof l?400==o.responseCode?new s(o.message):401==o.responseCode?new r(o.message):new c(o.responseCode+" "+o.message):new a(o);case 4:return[2]}}))}))},e.prototype.subscribeToMessages=function(e,t,n,r,i){var o=null!=i?i:this.relayUrl;return new Promise((function(i,s){var a=!1,u=new EventSource(o+"?token="+e);u.onopen=function(){a||(i(u),a=!0)},u.onerror=function(){a?n&&n(new c):(s(new c),a=!0)},u.addEventListener("message",(function(e){var n=JSON.parse(e.data);t(n)})),r&&u.addEventListener("relay_event",(function(e){var t=JSON.parse(e.data);r(t)}))}))},e}(),m=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},C=function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},_=function(){function e(e){this.networkClient=null!=e?e:new g}return e.prototype.getRelayUrls=function(e){return m(this,void 0,void 0,(function(){var t,n,r,i,o,s;return C(this,(function(a){switch(a.label){case 0:return[4,this.networkClient.get("https://raw.githubusercontent.com/uhst/relays/main/list.json")];case 1:if(t=a.sent(),e){for(n=e.split("-")[0],r=0,i=t;r<i.length;r++)if((o=i[r]).prefix===n)return[2,o.urls];return[2,[]]}return s=[],t.forEach((function(e){return e.urls.forEach((function(e){return s.push(e)}))})),[2,s]}}))}))},e.prototype.getBestRelayUrl=function(e){return m(this,void 0,void 0,(function(){var t,n=this;return C(this,(function(r){switch(r.label){case 0:return[4,this.getRelayUrls(e)];case 1:return t=r.sent(),[2,new Promise((function(e,r){var i=!1,o=0;0===t.length?r(new a):t.sort((function(){return Math.random()-Math.random()})).slice(0,Math.min(t.length,10)).forEach((function(s){return m(n,void 0,void 0,(function(){var n;return C(this,(function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,this.networkClient.post(s,["action=ping","timestamp="+Date.now()])];case 1:return a.sent(),i||(e(s),i=!0),[3,3];case 2:return n=a.sent(),o++,i||o!=t.length||r(n),[3,3];case 3:return[2]}}))}))}))}))]}}))}))},e}(),k=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},S=function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},O=function(){function e(e,t){this.relayClientProvider=e,this.relayUrlsProvider=null!=t?t:new _}return e.prototype.initHost=function(e){return k(this,void 0,void 0,(function(){var t,n,r,i;return S(this,(function(o){switch(o.label){case 0:return[4,this.relayUrlsProvider.getBestRelayUrl(e)];case 1:t=o.sent(),r=new a,o.label=2;case 2:return o.trys.push([2,4,,5]),this.relayClient=this.relayClientProvider.createRelayClient(t),[4,this.relayClient.initHost(e)];case 3:return n=o.sent(),[3,5];case 4:return i=o.sent(),r=i,[3,5];case 5:return[2,new Promise((function(e,t){n?e(n):t(r)}))]}}))}))},e.prototype.initClient=function(e){return k(this,void 0,void 0,(function(){var t,n,r,o,s,c,u;return S(this,(function(l){switch(l.label){case 0:return[4,this.relayUrlsProvider.getRelayUrls(e)];case 1:t=l.sent(),r=new a,o=0,s=t,l.label=2;case 2:if(!(o<s.length))return[3,7];c=s[o],l.label=3;case 3:return l.trys.push([3,5,,6]),this.relayClient=this.relayClientProvider.createRelayClient(c),[4,this.relayClient.initClient(e)];case 4:return n=l.sent(),[3,7];case 5:return u=l.sent(),r=u,u instanceof i?[3,7]:[3,6];case 6:return o++,[3,2];case 7:return[2,new Promise((function(e,t){n?e(n):t(r)}))]}}))}))},e.prototype.sendMessage=function(e,t,n){return this.relayClient.sendMessage(e,t,n)},e.prototype.subscribeToMessages=function(e,t,n,r,i){return this.relayClient.subscribeToMessages(e,t,n,r,i)},e}();function I(e){this.message=e}I.prototype=new Error,I.prototype.name="InvalidCharacterError";var E="undefined"!=typeof window&&window.atob&&window.atob.bind(window)||function(e){var t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new I("'atob' failed: The string to be decoded is not correctly encoded.");for(var n,r,i=0,o=0,s="";r=t.charAt(o++);~r&&(n=i%4?64*n+r:r,i++%4)?s+=String.fromCharCode(255&n>>(-2*i&6)):0)r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(r);return s};function T(e){var t=e.replace(/-/g,"+").replace(/_/g,"/");switch(t.length%4){case 0:break;case 2:t+="==";break;case 3:t+="=";break;default:throw"Illegal base64url string!"}try{return function(e){return decodeURIComponent(E(e).replace(/(.)/g,(function(e,t){var n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n})))}(t)}catch(e){return E(t)}}function P(e){this.message=e}P.prototype=new Error,P.prototype.name="InvalidTokenError";var U,M,x=function(){function e(e,t){this.emitter=e,this.handler=t}return e.prototype.getHandler=function(){return this.handler},e}(),R=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),j=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return R(t,e),t.prototype.run=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];this.handler.apply(null,t)},t}(x),N=function(){var e=function(t,n){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])})(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}(),H=function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r},J=function(e){function t(t,n,r){void 0===r&&(r=1);var i=e.call(this,t,n)||this;if(i.total=r,i.i=0,i.total<1)throw new Error("{total} can not be less than 1");return i}return N(t,e),t.prototype.run=function(t){for(var n=[],r=1;r<arguments.length;r++)n[r-1]=arguments[r];e.prototype.run.apply(this,H([t],n)),++this.i>=this.total&&this.emitter.off(t,this.handler)},t}(j),A=function(){for(var e=0,t=0,n=arguments.length;t<n;t++)e+=arguments[t].length;var r=Array(e),i=0;for(t=0;t<n;t++)for(var o=arguments[t],s=0,a=o.length;s<a;s++,i++)r[i]=o[s];return r},D=function(){function e(){this._events=Object.create(null)}return e.prototype.on=function(e,t){this._addEventListener(e,new j(this,t))},e.prototype.once=function(e,t){this._addEventListener(e,new J(this,t,1))},e.prototype.off=function(e,t){var n=this._events[e];(null==n?void 0:n.length)&&(this._events[e]=n.filter((function(e){return e.getHandler()!==t})))},e.prototype.offByName=function(e){var t=this._events[e];void 0!==t&&(t.length=0,delete this._events[e])},e.prototype.offAll=function(){var e=this;Object.keys(this._events).forEach((function(t){var n=e._events[t];n&&(n.length=0)})),this._events=Object.create(null)},e.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];var r=this._events[e];r&&r.forEach((function(n){return n.run.apply(n,A([e],t))}))},e.prototype.has=function(e,t){var n=this._events[e];if(!n)return!1;for(var r=0;r<n.length;r++)if(n[r].getHandler()===t)return!0;return!1},e.prototype._addEventListener=function(e,t){var n=this._events[e];Array.isArray(n)?n.push(t):this._events[e]=[t]},e}();!function(e){e.STRING="string",e.BLOB="blob"}(U||(U={})),function(e){e.CLIENT_CLOSED="client_closed",e.HOST_CLOSED="host_closed"}(M||(M={}));var L=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},G=function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},W=function(){function e(e,t,n,r){var i=this;this.relayClient=e,this.socketProvider=t,this.debug=r,this._ee=new D,this.clients=new Map,this.handleMessage=function(e){var t=function(e,t){if("string"!=typeof e)throw new P("Invalid token specified");var n=!0===(t=t||{}).header?0:1;try{return JSON.parse(T(e.split(".")[n]))}catch(e){throw new P("Invalid token specified: "+e.message)}}(e.responseToken).clientId,n=i.clients.get(t);if(!n){var r=i.socketProvider.createUhstSocket(i.relayClient,{type:"host",token:e.responseToken,sendUrl:i.config.sendUrl,clientId:t},i.debug);i.debug&&i._ee.emit("diagnostic","Host received client connection from clientId: "+t),i._ee.emit("connection",r),i.clients.set(t,r),n=r}n.handleMessage(e)},this.handleRelayEvent=function(e){var t;if(e.eventType===M.CLIENT_CLOSED){var n=e.body;null===(t=i.clients.get(n))||void 0===t||t.close(),i.clients.delete(n)}},this.handleRelayError=function(){var e;null===(e=i.relayMessageStream)||void 0===e||e.close(),i.debug&&i._ee.emit("diagnostic","Host connection to relay dropped."),i._ee.emit("error",new c)},this.handleMessage=this.handleMessage.bind(this),this.init(n)}return Object.defineProperty(e.prototype,"hostId",{get:function(){return this.config.hostId},enumerable:!1,configurable:!0}),e.prototype.broadcast=function(e){return L(this,void 0,void 0,(function(){var t,n;return G(this,(function(r){switch(r.label){case 0:t={type:"string",payload:e},r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.relayClient.sendMessage(this.config.hostToken,t,this.config.sendUrl)];case 2:return r.sent(),this.debug&&this._ee.emit("diagnostic","Sent message "+e),[3,4];case 3:return n=r.sent(),this.debug&&this._ee.emit("diagnostic","Failed sending message: "+JSON.stringify(n)),this._ee.emit("error",n),[3,4];case 4:return[2]}}))}))},e.prototype.on=function(e,t){this._ee.on(e,t)},e.prototype.once=function(e,t){this._ee.once(e,t)},e.prototype.off=function(e,t){this._ee.off(e,t)},e.prototype.disconnect=function(){var e;null===(e=this.relayMessageStream)||void 0===e||e.close()},e.prototype.init=function(e){return L(this,void 0,void 0,(function(){var t,n,r;return G(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),t=this,[4,this.relayClient.initHost(e)];case 1:return t.config=i.sent(),this.debug&&this._ee.emit("diagnostic","Host configuration received from server."),n=this,[4,this.relayClient.subscribeToMessages(this.config.hostToken,this.handleMessage,this.handleRelayError,this.handleRelayEvent,this.config.receiveUrl)];case 2:return n.relayMessageStream=i.sent(),this.debug&&this._ee.emit("diagnostic","Host subscribed to messages from server."),this._ee.emit("ready"),[3,4];case 3:return r=i.sent(),this.relayMessageStream=void 0,this.debug&&this._ee.emit("diagnostic","Host message subscription failed: "+JSON.stringify(r)),this._ee.emit("error",r),[3,4];case 4:return[2]}}))}))},e}(),B=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},F=function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},Y=function(){function e(e,t,n){var r=this;switch(this.relayClient=e,this.debug=n,this._ee=new D,this.handleMessage=function(e){var t=e.body.payload;r.debug&&r._ee.emit("diagnostic","Message received: "+t),r._ee.emit("message",t)},this.handleRelayEvent=function(e){e.eventType===M.HOST_CLOSED&&(r.debug&&r._ee.emit("diagnostic","Host disconnected from relay."),r.close())},this.handleRelayError=function(){r.debug&&r._ee.emit("diagnostic","Client connection to relay dropped."),r.close()},this.send=this.send.bind(this),this.handleMessage=this.handleMessage.bind(this),this.close=this.close.bind(this),t.type){case"client":this.initClient(t.hostId),this._remoteId=t.hostId;break;case"host":this.token=t.token,this.sendUrl=t.sendUrl,this._remoteId=t.clientId,setTimeout((function(){r._ee.emit("open")}));break;default:throw Error("Unsupported Socket Parameters Type")}}return Object.defineProperty(e.prototype,"remoteId",{get:function(){return this._remoteId},enumerable:!1,configurable:!0}),e.prototype.on=function(e,t){this._ee.on(e,t)},e.prototype.once=function(e,t){this._ee.once(e,t)},e.prototype.off=function(e,t){this._ee.off(e,t)},e.prototype.send=function(e){return B(this,void 0,void 0,(function(){var t,n;return F(this,(function(r){switch(r.label){case 0:t={type:"string",payload:e},r.label=1;case 1:return r.trys.push([1,3,,4]),[4,this.relayClient.sendMessage(this.token,t,this.sendUrl)];case 2:return r.sent(),this.debug&&this._ee.emit("diagnostic","Sent message "+e),[3,4];case 3:return n=r.sent(),this.debug&&this._ee.emit("diagnostic","Failed sending message: "+JSON.stringify(n)),this._ee.emit("error",n),[3,4];case 4:return[2]}}))}))},e.prototype.close=function(){var e;null===(e=this.relayMessageStream)||void 0===e||e.close(),this._ee.emit("close")},e.prototype.initClient=function(e){return B(this,void 0,void 0,(function(){var t,n,r;return F(this,(function(i){switch(i.label){case 0:return i.trys.push([0,3,,4]),[4,this.relayClient.initClient(e)];case 1:return t=i.sent(),this.debug&&this._ee.emit("diagnostic","Client configuration received from server."),this.token=t.clientToken,this.sendUrl=t.sendUrl,n=this,[4,this.relayClient.subscribeToMessages(t.clientToken,this.handleMessage,this.handleRelayError,this.handleRelayEvent,t.receiveUrl)];case 2:return n.relayMessageStream=i.sent(),this.debug&&this._ee.emit("diagnostic","Client subscribed to messages from server."),this._ee.emit("open"),[3,4];case 3:return r=i.sent(),this.relayMessageStream=void 0,this.debug&&this._ee.emit("diagnostic","Client failed: "+JSON.stringify(r)),this._ee.emit("error",r),[3,4];case 4:return[2]}}))}))},e}(),q=function(){function e(){}return e.prototype.createUhstSocket=function(e,t,n){return new Y(e,t,n)},e}(),z=function(){function e(){}return e.prototype.createRelayClient=function(e){return new w(e)},e}(),K=function(){function e(e){var t,n;void 0===e&&(e={}),this.debug=null!==(t=e.debug)&&void 0!==t&&t,e.relayClient?this.relayClient=e.relayClient:e.relayUrl?this.relayClient=new w(e.relayUrl):this.relayClient=new O(new z),this.socketProvider=null!==(n=e.socketProvider)&&void 0!==n?n:new q}return e.prototype.join=function(e){return this.socketProvider.createUhstSocket(this.relayClient,{type:"client",hostId:e},this.debug)},e.prototype.host=function(e){return new W(this.relayClient,this.socketProvider,e,this.debug)},e}(),Q=function(e,t,n,r){return new(n||(n=Promise))((function(i,o){function s(e){try{c(r.next(e))}catch(e){o(e)}}function a(e){try{c(r.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(s,a)}c((r=r.apply(e,t||[])).next())}))},V=function(e,t){var n,r,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function a(o){return function(a){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,r=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!(i=s.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,a])}}},X=function(){function e(e,t,n,r){switch(this.relayClient=e,this.configuration=t,this.debug=r,this._ee=new D,this._pendingCandidates=[],this._offerAccepted=!1,this.send=this.send.bind(this),this.processIceCandidates=this.processIceCandidates.bind(this),this.initClient=this.initClient.bind(this),this.initHost=this.initHost.bind(this),this.handleIceCandidate=this.handleIceCandidate.bind(this),this.handleConnectionStateChange=this.handleConnectionStateChange.bind(this),this.configureDataChannel=this.configureDataChannel.bind(this),this.createConnection=this.createConnection.bind(this),this.handleMessage=this.handleMessage.bind(this),this.close=this.close.bind(this),this.connection=this.createConnection(),n.type){case"client":this.initClient(n.hostId),this._remoteId=n.hostId;break;case"host":this.token=n.token,this.sendUrl=n.sendUrl,this._remoteId=n.clientId;break;default:throw Error("Unsupported Socket Parameters Type")}}return Object.defineProperty(e.prototype,"remoteId",{get:function(){return this._remoteId},enumerable:!1,configurable:!0}),e.prototype.on=function(e,t){this._ee.on(e,t)},e.prototype.once=function(e,t){this._ee.once(e,t)},e.prototype.off=function(e,t){this._ee.off(e,t)},e.prototype.send=function(e){return this.debug&&this._ee.emit("diagnostic","Sent message on data channel: "+e),this.dataChannel.send(e),Promise.resolve()},e.prototype.close=function(){this.connection.close()},e.prototype.handleMessage=function(e){"offer"===e.body.type?(this.debug&&this._ee.emit("diagnostic","Received offer: "+JSON.stringify(e.body)),this.initHost(e.body)):"answer"===e.body.type?(this.debug&&this._ee.emit("diagnostic","Received answer: "+JSON.stringify(e.body)),this.connection.setRemoteDescription(e.body),this._offerAccepted=!0,this.processIceCandidates()):(this.debug&&this._ee.emit("diagnostic","Received ICE Candidates: "+JSON.stringify(e.body)),this._pendingCandidates.push(e.body),this.processIceCandidates())},e.prototype.createConnection=function(){var e=new RTCPeerConnection(this.configuration);return e.onconnectionstatechange=this.handleConnectionStateChange,e.onicecandidate=this.handleIceCandidate,e},e.prototype.configureDataChannel=function(){var e=this;this.dataChannel.onopen=function(){e.debug&&e._ee.emit("diagnostic","Data channel opened."),e.relayMessageStream&&(e.debug&&e._ee.emit("diagnostic","Closing RELAY message stream."),e.relayMessageStream.close()),e._ee.emit("open")},this.dataChannel.onclose=function(){e.debug&&e._ee.emit("diagnostic","Data channel closed."),e._ee.emit("close")},this.dataChannel.onmessage=function(t){e.debug&&e._ee.emit("diagnostic","Message received on data channel: "+t.data),e._ee.emit("message",t.data)}},e.prototype.handleConnectionStateChange=function(e){switch(this.connection.connectionState){case"connected":this.debug&&this._ee.emit("diagnostic","WebRTC connection established.");break;case"disconnected":this.debug&&this._ee.emit("diagnostic","WebRTC connection disconnected.");break;case"failed":this.debug&&this._ee.emit("diagnostic","WebRTC connection failed.");break;case"closed":this.debug&&this._ee.emit("diagnostic","WebRTC connection closed.")}},e.prototype.handleIceCandidate=function(e){var t=this;e.candidate?(this.debug&&this._ee.emit("diagnostic","Sending ICE candidate: "+JSON.stringify(e.candidate)),this.relayClient.sendMessage(this.token,e.candidate,this.sendUrl).catch((function(e){t.debug&&t._ee.emit("diagnostic","Failed sending ICE candidate: "+JSON.stringify(e)),t._ee.emit("error",e)}))):this.debug&&this._ee.emit("diagnostic","ICE gathering completed.")},e.prototype.initHost=function(e){return Q(this,void 0,void 0,(function(){var t,n=this;return V(this,(function(r){switch(r.label){case 0:return this.connection.ondatachannel=function(e){n.debug&&n._ee.emit("diagnostic","Received new data channel: "+JSON.stringify(e.channel)),n.dataChannel=e.channel,n.configureDataChannel()},[4,this.connection.setRemoteDescription(e)];case 1:return r.sent(),this.debug&&this._ee.emit("diagnostic","Set remote description on host: "+JSON.stringify(e)),[4,this.connection.createAnswer()];case 2:return t=r.sent(),this.relayClient.sendMessage(this.token,t,this.sendUrl).then((function(){n.debug&&n._ee.emit("diagnostic","Host sent offer answer: "+JSON.stringify(t))})).catch((function(e){n.debug&&n._ee.emit("diagnostic","Host failed responding to offer:"+JSON.stringify(e)),n._ee.emit("error",e)})),[4,this.connection.setLocalDescription(t)];case 3:return r.sent(),this.debug&&this._ee.emit("diagnostic","Local description set to offer answer on host."),this._offerAccepted=!0,this.processIceCandidates(),[2]}}))}))},e.prototype.initClient=function(e){return Q(this,void 0,void 0,(function(){var t,n,r,i,o=this;return V(this,(function(s){switch(s.label){case 0:return s.trys.push([0,5,,6]),this.dataChannel=this.connection.createDataChannel("uhst"),this.debug&&this._ee.emit("diagnostic","Data channel created on client."),this.configureDataChannel(),[4,this.relayClient.initClient(e)];case 1:return t=s.sent(),this.debug&&this._ee.emit("diagnostic","Client configuration received from server."),this.token=t.clientToken,this.sendUrl=t.sendUrl,n=this,[4,this.relayClient.subscribeToMessages(t.clientToken,this.handleMessage,void 0,void 0,t.receiveUrl)];case 2:return n.relayMessageStream=s.sent(),this.debug&&this._ee.emit("diagnostic","Client subscribed to messages from server."),[4,this.connection.createOffer()];case 3:return r=s.sent(),this.relayClient.sendMessage(this.token,r,this.sendUrl).then((function(){o.debug&&o._ee.emit("diagnostic","Client offer sent to host: "+JSON.stringify(r))})).catch((function(e){o.debug&&o._ee.emit("diagnostic","Client failed: "+JSON.stringify(e)),o._ee.emit("error",e)})),[4,this.connection.setLocalDescription(r)];case 4:return s.sent(),this.debug&&this._ee.emit("diagnostic","Local description set on client."),[3,6];case 5:return i=s.sent(),this.debug&&this._ee.emit("diagnostic","Client failed: "+JSON.stringify(i)),this._ee.emit("error",i),[3,6];case 6:return[2]}}))}))},e.prototype.processIceCandidates=function(){if(this._offerAccepted)for(this.debug&&this._ee.emit("diagnostic","Offer accepted, processing cached ICE candidates.");this._pendingCandidates.length>0;){var e=this._pendingCandidates.pop();e&&(this.connection.addIceCandidate(e),this.debug&&this._ee.emit("diagnostic","Added ICE candidate: "+JSON.stringify(e)))}},e}(),Z=function(){function e(e){this.rtcConfiguration=null!=e?e:{iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:global.stun.twilio.com:3478"}]}}return e.prototype.createUhstSocket=function(e,t,n){return new X(e,this.rtcConfiguration,t,n)},e}();e.HostIdAlreadyInUse=o,e.InvalidClientOrHostId=s,e.InvalidHostId=i,e.InvalidToken=r,e.NetworkClient=g,e.NetworkError=l,e.NetworkUnreachable=u,e.RelayClientProvider=z,e.RelayError=c,e.RelayUnreachable=a,e.UHST=K,e.WebRTCSocketProvider=Z,Object.defineProperty(e,"__esModule",{value:!0})}));
